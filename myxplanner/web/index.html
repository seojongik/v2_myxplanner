<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="/">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="A new Flutter project.">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="reservation_system">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>reservation_system</title>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <!-- Firebase SDK v9+ (ëª¨ë“ˆ ë°©ì‹) -->
  <script type="module">
    // Firebase v9+ ëª¨ë“ˆ import
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, where, getDocs, onSnapshot, writeBatch } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyAwsGmHtSWW9LdaO8R0I6wftQPkHtnUy94",
      authDomain: "mgpfunctions.firebaseapp.com",
      projectId: "mgpfunctions",
      storageBucket: "mgpfunctions.firebasestorage.app",
      messagingSenderId: "224974438083",
      appId: "1:224974438083:web:5dfe79140a6fe10cfcec76",
      measurementId: "G-0S32LNP1EL"
    };
    
    console.log('ğŸ”¥ Firebase v9+ JavaScript SDK ì´ˆê¸°í™” ì‹œì‘');
    try {
      // Firebase ì•± ì´ˆê¸°í™”
      const app = initializeApp(firebaseConfig);
      console.log('âœ… Firebase v9+ ì´ˆê¸°í™” ì„±ê³µ');
      console.log('âœ… Firebase í”„ë¡œì íŠ¸ ID:', app.options.projectId);
      
      // Firestore ì´ˆê¸°í™”
      const db = getFirestore(app);
      console.log('âœ… Firestore v9+ ì´ˆê¸°í™” ì„±ê³µ');
      
      // Flutterì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ê°„ë‹¨í•œ í•¨ìˆ˜ë“¤ ì •ì˜
      window.firebaseReady = true;
      window.firebaseApp = app;
      window.firestoreDb = db;
      
      // í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
      window.testJSFunction = function(param1, param2) {
        console.log('ğŸ§ª [JS] testJSFunction í˜¸ì¶œë¨');
        console.log('ğŸ§ª [JS] param1:', param1);
        console.log('ğŸ§ª [JS] param2:', param2);
        return `í…ŒìŠ¤íŠ¸ ì„±ê³µ: ${param1}, ${param2}`;
      };
      
      // ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ (Promise ë°˜í™˜)
      window.getFirebaseDocument = async function(collection, docId) {
        try {
          console.log('ğŸ” [JS] getFirebaseDocument í˜¸ì¶œë¨!');
          console.log('ğŸ” [JS] arguments ê°œìˆ˜:', arguments.length);
          console.log('ğŸ” [JS] collection íƒ€ì…:', typeof collection, 'value:', collection);
          console.log('ğŸ” [JS] docId íƒ€ì…:', typeof docId, 'value:', docId);
          
          if (!collection || !docId) {
            throw new Error(`Invalid parameters: collection=${collection}, docId=${docId}`);
          }
          
          const docRef = doc(db, collection, docId);
          console.log('ğŸ” [JS] docRef ìƒì„± ì™„ë£Œ');
          
          const docSnap = await getDoc(docRef);
          console.log('ğŸ” [JS] getDoc ì™„ë£Œ, exists:', docSnap.exists());
          
          if (docSnap.exists()) {
            const data = docSnap.data();
            console.log('âœ… [JS] ë¬¸ì„œ ë°ì´í„°:', data);
            return { exists: true, data: data };
          } else {
            console.log('â„¹ï¸ [JS] ë¬¸ì„œ ì—†ìŒ');
            return { exists: false, data: null };
          }
        } catch (error) {
          console.error('âŒ [JS] getDocument ì—ëŸ¬:', error);
          throw error;
        }
      };
      
      // ì„ì‹œ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
      window.testNewCode = function() {
        console.log('ğŸ§ª [JS] ìƒˆ ì½”ë“œê°€ ë¡œë“œë¨! í˜„ì¬ ì‹œê°„:', new Date().toISOString());
        return 'NEW_CODE_LOADED';
      };

      // ì½œë°± ë°©ì‹ ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
      window.getFirebaseDocumentCallback = function(collection, docId, onSuccess, onError) {
        console.log('ğŸ” [JS-NEW] getFirebaseDocumentCallback í˜¸ì¶œë¨ - ìƒˆ ë²„ì „');
        console.log('ğŸ” [JS-NEW] ì „ë‹¬ë°›ì€ íŒŒë¼ë¯¸í„° - collection:', collection, 'docId:', docId);
        console.log('ğŸ” [JS-NEW] íŒŒë¼ë¯¸í„° íƒ€ì… - collection:', typeof collection, 'docId:', typeof docId);

        getFirebaseDocument(collection, docId)
          .then(result => {
            console.log('âœ… [JS] ì½œë°± ì„±ê³µ:', result);
            console.log('ğŸ” [JS] result íƒ€ì…:', typeof result);
            console.log('ğŸ” [JS] result ìƒì„¸:', result);

            try {
              // ì•ˆì „í•œ JSON ë³€í™˜
              let jsonResult;
              if (result && typeof result === 'object') {
                // ê°ì²´ì¸ ê²½ìš° JSON.stringify ì‚¬ìš©
                jsonResult = JSON.stringify(result);
                console.log('âœ… [JS] JSON.stringify ì„±ê³µ:', jsonResult);
              } else {
                // ê¸°ë³¸ê°’ ì²˜ë¦¬
                jsonResult = JSON.stringify({ exists: false, data: null });
                console.log('âš ï¸ [JS] ê¸°ë³¸ê°’ ì‚¬ìš©:', jsonResult);
              }

              onSuccess(jsonResult);
            } catch (e) {
              console.error('âŒ [JS] JSON ë³€í™˜ ì‹¤íŒ¨:', e);
              const fallbackResult = JSON.stringify({ exists: false, data: null, error: 'JSON conversion failed' });
              onSuccess(fallbackResult);
            }
          })
          .catch(error => {
            console.error('âŒ [JS] ì½œë°± ì—ëŸ¬:', error);
            onError(error.message || error.toString());
          });
      };
      
      // ë™ê¸° ë°©ì‹ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë˜í¼
      window.getFirebaseDocumentSync = function(collection, docId) {
        console.log('ğŸ” [JS] getFirebaseDocumentSync í˜¸ì¶œë¨');
        return getFirebaseDocument(collection, docId);
      };
      
      // ë¬¸ì„œ ì„¤ì • í•¨ìˆ˜
      window.setFirebaseDocument = async function(collection, docId, data) {
        try {
          console.log('ğŸ” [JS] setFirebaseDocument í˜¸ì¶œë¨!');
          console.log('ğŸ” [JS] collection:', collection);
          console.log('ğŸ” [JS] docId:', docId);
          console.log('ğŸ” [JS] data íƒ€ì…:', typeof data);
          console.log('ğŸ” [JS] data:', data);
          
          // JSON ë¬¸ìì—´ì„ JavaScript ê°ì²´ë¡œ ë³€í™˜
          let cleanData;
          if (typeof data === 'string') {
            // JSON ë¬¸ìì—´ë¡œ ì „ë‹¬ëœ ê²½ìš°
            try {
              cleanData = JSON.parse(data);
              console.log('ğŸ” [JS] JSON íŒŒì‹± ì„±ê³µ:', cleanData);
            } catch (e) {
              console.error('âŒ [JS] JSON íŒŒì‹± ì‹¤íŒ¨:', e);
              cleanData = {};
            }
          } else if (data && typeof data === 'object') {
            // ê°ì²´ë¡œ ì „ë‹¬ëœ ê²½ìš° (ê¸°ì¡´ ë°©ì‹)
            console.log('ğŸ” [JS] data keys:', Object.keys(data));
            console.log('ğŸ” [JS] data entries:', Object.entries(data));
            
            // ìˆ˜ë™ìœ¼ë¡œ ê°ì²´ ë³µì‚¬
            cleanData = {};
            for (const key in data) {
              if (data.hasOwnProperty(key)) {
                cleanData[key] = data[key];
              }
            }
            
            // ì¶”ê°€ë¡œ Symbolì„ í†µí•´ ì ‘ê·¼ ì‹œë„
            try {
              const symbols = Object.getOwnPropertySymbols(data);
              console.log('ğŸ” [JS] symbols:', symbols);
              for (const symbol of symbols) {
                const value = data[symbol];
                console.log('ğŸ” [JS] symbol value:', value);
                if (value && typeof value === 'object') {
                  cleanData = {...value};
                }
              }
            } catch (e) {
              console.log('ğŸ” [JS] symbol ì ‘ê·¼ ì‹¤íŒ¨:', e);
            }
            
            console.log('ğŸ” [JS] cleanData:', cleanData);
          } else {
            cleanData = data;
          }
          
          const docRef = doc(db, collection, docId);
          console.log('ğŸ” [JS] docRef ìƒì„± ì™„ë£Œ');
          
          await setDoc(docRef, cleanData);
          console.log('âœ… [JS] ë¬¸ì„œ ì„¤ì • ì„±ê³µ');
          
          return { success: true };
        } catch (error) {
          console.error('âŒ [JS] setDocument ì—ëŸ¬:', error);
          throw error;
        }
      };
      
      // ì½œë°± ë°©ì‹ ë¬¸ì„œ ì„¤ì • í•¨ìˆ˜
      window.setFirebaseDocumentCallback = function(collection, docId, data, onSuccess, onError) {
        console.log('ğŸ” [JS] setFirebaseDocumentCallback í˜¸ì¶œë¨');
        
        setFirebaseDocument(collection, docId, data)
          .then(result => {
            console.log('âœ… [JS] ì„¤ì • ì½œë°± ì„±ê³µ:', result);
            onSuccess(result);
          })
          .catch(error => {
            console.error('âŒ [JS] ì„¤ì • ì½œë°± ì—ëŸ¬:', error);
            onError(error.message || error.toString());
          });
      };
      
      // ë©”ì‹œì§€ ìŠ¤íŠ¸ë¦¼ í•¨ìˆ˜
      window.getMessagesStream = function(chatRoomId, onMessage, onError) {
        try {
          console.log('ğŸ” [JS] getMessagesStream ì‹œì‘:', chatRoomId);
          
          const messagesRef = collection(db, 'messages');
          const q = query(messagesRef, where('chatRoomId', '==', chatRoomId));
          
          // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
          const unsubscribe = onSnapshot(q, (snapshot) => {
            console.log('ğŸ“¨ [JS] onSnapshot ì½œë°± í˜¸ì¶œë¨');
            console.log('ğŸ“¨ [JS] snapshot.size:', snapshot.size);
            
            const messages = [];
            snapshot.forEach((doc) => {
              const data = doc.data();
              console.log('ğŸ“¨ [JS] ì›ë³¸ ë¬¸ì„œ ë°ì´í„°:', data);
              
              // ìˆœìˆ˜í•œ JavaScript ê°ì²´ë¡œ ë³€í™˜
              const cleanMessage = {
                id: doc.id,
                chatRoomId: data.chatRoomId || '',
                branchId: data.branchId || '',
                senderId: data.senderId || '',
                senderType: data.senderType || '',
                senderName: data.senderName || '',
                message: data.message || '',
                isRead: data.isRead || false,
                // timestampë¥¼ ISO ë¬¸ìì—´ë¡œ ë³€í™˜
                timestamp: data.timestamp ? (data.timestamp.toDate ? data.timestamp.toDate().toISOString() : data.timestamp.toString()) : new Date().toISOString()
              };
              
              console.log('ğŸ“¨ [JS] ì •ë¦¬ëœ ë©”ì‹œì§€:', cleanMessage);
              messages.push(cleanMessage);
            });
            
            console.log('ğŸ“¨ [JS] ì •ë ¬ ì „ ë©”ì‹œì§€ ë°°ì—´ ê¸¸ì´:', messages.length);
            
            // ì‹œê°„ìˆœ ì •ë ¬ (ISO ë¬¸ìì—´ ë¹„êµ)
            messages.sort((a, b) => {
              const aTime = new Date(a.timestamp).getTime();
              const bTime = new Date(b.timestamp).getTime();
              console.log('ğŸ“¨ [JS] ì •ë ¬ ë¹„êµ:', aTime, 'vs', bTime);
              return aTime - bTime;
            });
            
            console.log('ğŸ“¨ [JS] ì •ë ¬ í›„ ë©”ì‹œì§€ ë°°ì—´:', messages);
            console.log('ğŸ“¨ [JS] onMessage ì½œë°± í˜¸ì¶œ - ë©”ì‹œì§€ ìˆ˜:', messages.length);
            
            try {
              // JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•´ì„œ ì „ë‹¬
              const messagesJsonString = JSON.stringify(messages);
              console.log('ğŸ“¨ [JS] JSON ë¬¸ìì—´ ë³€í™˜:', messagesJsonString);
              
              onMessage(messagesJsonString);
              console.log('âœ… [JS] onMessage ì½œë°± ì™„ë£Œ');
            } catch (e) {
              console.error('âŒ [JS] onMessage ì½œë°± ì—ëŸ¬:', e);
            }
          }, (error) => {
            console.error('âŒ [JS] ë©”ì‹œì§€ ìŠ¤íŠ¸ë¦¼ ì—ëŸ¬:', error);
            onError(error.message || error.toString());
          });
          
          return unsubscribe;
        } catch (error) {
          console.error('âŒ [JS] getMessagesStream ì—ëŸ¬:', error);
          onError(error.message || error.toString());
        }
      };
      
      // ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ í•¨ìˆ˜
      window.markMessagesAsReadCallback = function(chatRoomId, senderType, onSuccess, onError) {
        console.log('ğŸ“– [JS] ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ ì‹œì‘:', chatRoomId, senderType);
        
        (async () => {
          try {
            // í•´ë‹¹ ì±„íŒ…ë°©ì˜ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ë“¤ ì¡°íšŒ
            const messagesRef = collection(db, 'messages');
            const q = query(
              messagesRef, 
              where('chatRoomId', '==', chatRoomId),
              where('senderType', '==', senderType),
              where('isRead', '==', false)
            );
            
            const unreadSnapshot = await getDocs(q);
            console.log('ğŸ“– [JS] ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜:', unreadSnapshot.size);
            
            if (unreadSnapshot.size === 0) {
              console.log('ğŸ“– [JS] ì½ì§€ ì•Šì€ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤');
              onSuccess({ success: true, updatedCount: 0 });
              return;
            }
            
            // ë°°ì¹˜ë¡œ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ì½ìŒ ì²˜ë¦¬
            const batch = writeBatch(db);
            let updateCount = 0;
            
            unreadSnapshot.forEach((doc) => {
              batch.update(doc.ref, { isRead: true });
              updateCount++;
            });
            
            // ì±„íŒ…ë°© ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ ì—…ë°ì´íŠ¸
            const chatRoomRef = doc(db, 'chatRooms', chatRoomId);
            const updateField = senderType === 'admin' ? 'memberUnreadCount' : 'adminUnreadCount';
            batch.update(chatRoomRef, { [updateField]: 0 });
            
            await batch.commit();
            console.log('âœ… [JS] ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ ì™„ë£Œ, ì—…ë°ì´íŠ¸ëœ ë©”ì‹œì§€ ìˆ˜:', updateCount);
            
            onSuccess({ success: true, updatedCount: updateCount });
          } catch (error) {
            console.error('âŒ [JS] ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ ì—ëŸ¬:', error);
            onError(error.message || error.toString());
          }
        })();
      };
      
      // ì•ˆì½ì€ ë©”ì‹œì§€ ìˆ˜ ìŠ¤íŠ¸ë¦¼ í•¨ìˆ˜
      window.getUnreadCountStream = function(chatRoomId, onUpdate, onError) {
        try {
          console.log('ğŸ”” [JS] ì•ˆì½ì€ ë©”ì‹œì§€ ìˆ˜ ìŠ¤íŠ¸ë¦¼ ì‹œì‘:', chatRoomId);
          
          const chatRoomRef = doc(db, 'chatRooms', chatRoomId);
          
          // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
          const unsubscribe = onSnapshot(chatRoomRef, (snapshot) => {
            if (snapshot.exists()) {
              const data = snapshot.data();
              const unreadCount = data.memberUnreadCount || 0;
              console.log('ğŸ”” [JS] ì•ˆì½ì€ ë©”ì‹œì§€ ìˆ˜ ì—…ë°ì´íŠ¸:', unreadCount);
              onUpdate(unreadCount);
            } else {
              console.log('ğŸ”” [JS] ì±„íŒ…ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ, ì•ˆì½ì€ ë©”ì‹œì§€ ìˆ˜: 0');
              onUpdate(0);
            }
          }, (error) => {
            console.error('âŒ [JS] ì•ˆì½ì€ ë©”ì‹œì§€ ìˆ˜ ìŠ¤íŠ¸ë¦¼ ì—ëŸ¬:', error);
            onError(error.message || error.toString());
          });
          
          return unsubscribe;
        } catch (error) {
          console.error('âŒ [JS] getUnreadCountStream ì—ëŸ¬:', error);
          onError(error.message || error.toString());
        }
      };
      
      // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜ (ì½œë°± ë°©ì‹)
      window.sendMessageCallback = function(chatRoomId, branchId, senderId, senderName, senderType, messageText, onSuccess, onError) {
        console.log('ğŸ“¤ [JS] ë©”ì‹œì§€ ì „ì†¡ ì‹œì‘:', messageText);
        
        const messageId = `${branchId}_${senderId}_${Date.now()}`;
        const messageData = {
          id: messageId,
          chatRoomId: chatRoomId,
          branchId: branchId,
          senderId: senderId,
          senderType: senderType,
          senderName: senderName,
          message: messageText,
          timestamp: new Date(),
          isRead: false
        };
        
        // ë¹„ë™ê¸° ë©”ì‹œì§€ ì „ì†¡
        (async () => {
          try {
            console.log('ğŸ“¤ [JS] ë©”ì‹œì§€ ë°ì´í„° ì¤€ë¹„:', messageData);
            
            // ë©”ì‹œì§€ ì»¬ë ‰ì…˜ì— ì¶”ê°€
            const messagesRef = collection(db, 'messages');
            const docRef = await addDoc(messagesRef, messageData);
            console.log('âœ… [JS] ë©”ì‹œì§€ ë¬¸ì„œ ìƒì„± ì„±ê³µ, ID:', docRef.id);
            
            // ì±„íŒ…ë°© ì—…ë°ì´íŠ¸ - ê¸°ì¡´ ë°ì´í„° ê°€ì ¸ì™€ì„œ ì—…ë°ì´íŠ¸
            const chatRoomRef = doc(db, 'chatRooms', chatRoomId);
            const chatRoomSnap = await getDoc(chatRoomRef);
            
            if (chatRoomSnap.exists()) {
              const existingData = chatRoomSnap.data();
              console.log('ğŸ“¤ [JS] ê¸°ì¡´ ì±„íŒ…ë°© ë°ì´í„°:', existingData);
              
              const updatedData = {
                ...existingData,
                lastMessage: messageText,
                lastMessageTime: new Date(),
                adminUnreadCount: (existingData.adminUnreadCount || 0) + (senderType === 'member' ? 1 : 0)
              };
              
              console.log('ğŸ“¤ [JS] ì—…ë°ì´íŠ¸í•  ì±„íŒ…ë°© ë°ì´í„°:', updatedData);
              await setDoc(chatRoomRef, updatedData);
              console.log('âœ… [JS] ì±„íŒ…ë°© ì—…ë°ì´íŠ¸ ì„±ê³µ');
            } else {
              console.log('âŒ [JS] ì±„íŒ…ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }
            
            console.log('âœ… [JS] ë©”ì‹œì§€ ì „ì†¡ ì™„ì „ ì„±ê³µ');
            onSuccess({ success: true });
          } catch (error) {
            console.error('âŒ [JS] ë©”ì‹œì§€ ì „ì†¡ ì—ëŸ¬:', error);
            console.error('âŒ [JS] ì—ëŸ¬ ìŠ¤íƒ:', error.stack);
            onError(error.message || error.toString());
          }
        })();
      };
      
      console.log('âœ… Firebase ì „ì—­ í•¨ìˆ˜ ì„¤ì • ì™„ë£Œ');
      
    } catch (error) {
      console.error('âŒ Firebase v9+ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    }
  </script>
  
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>
