default_platform(:ios)

platform :ios do
  # IPA íŒŒì¼ ê²½ë¡œ ì°¾ê¸° í—¬í¼ í•¨ìˆ˜
  def find_ipa_path
    # ios ë””ë ‰í† ë¦¬ì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ, ìƒìœ„ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
    project_root = File.expand_path("../..", __dir__)
    ipa_dir = File.join(project_root, "build/ios/ipa")
    ipa_files = Dir.glob("#{ipa_dir}/*.ipa")
    
    if ipa_files.empty?
      UI.user_error!("IPA íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¹Œë“œë¥¼ ì‹¤í–‰í•˜ì„¸ìš”. (ê²€ìƒ‰ ê²½ë¡œ: #{ipa_dir})")
    end
    
    ipa_path = ipa_files.first
    UI.success("IPA íŒŒì¼ ë°œê²¬: #{ipa_path}")
    return ipa_path
  end

  # App Store Connect API í‚¤ ì„¤ì • (ìˆìœ¼ë©´ ì‚¬ìš©)
  def setup_api_key
    api_key_path = File.expand_path("AuthKey.p8", __dir__)
    
    # í‚¤ IDëŠ” íŒŒì¼ ì´ë¦„ì—ì„œ ì¶”ì¶œ (AuthKey_HW699DC545.p8 -> HW699DC545)
    # ë˜ëŠ” í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
    key_id = ENV["APP_STORE_CONNECT_API_KEY_ID"] || "HW699DC545"
    
    # Issuer IDëŠ” í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
    # App Store Connect â†’ ì‚¬ìš©ì ë° ì•¡ì„¸ìŠ¤ â†’ í‚¤ í˜ì´ì§€ ìƒë‹¨ì—ì„œ í™•ì¸ ê°€ëŠ¥
    issuer_id = ENV["APP_STORE_CONNECT_ISSUER_ID"]
    
    if File.exist?(api_key_path)
      if issuer_id
        app_store_connect_api_key(
          key_id: key_id,
          issuer_id: issuer_id,
          key_filepath: api_key_path,
          duration: 1200, # 20ë¶„
          in_house: false,
          set_spaceship_token: true
        )
        UI.success("âœ… App Store Connect API í‚¤ ì‚¬ìš© (Key ID: #{key_id})")
        return true
      else
        UI.important("âš ï¸ Issuer IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        UI.important("   Issuer ID í™•ì¸ ë°©ë²•:")
        UI.important("   1. App Store Connect (https://appstoreconnect.apple.com) ë¡œê·¸ì¸")
        UI.important("   2. ì‚¬ìš©ì ë° ì•¡ì„¸ìŠ¤ â†’ í‚¤ í˜ì´ì§€ë¡œ ì´ë™")
        UI.important("   3. í˜ì´ì§€ ìƒë‹¨ì˜ 'Issuer ID' ë³µì‚¬")
        UI.important("   4. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •: export APP_STORE_CONNECT_ISSUER_ID='your-issuer-id'")
        UI.important("")
        UI.important("   ë˜ëŠ” í‚¤ì²´ì¸ ì¸ì¦ì„ ì‚¬ìš©í•©ë‹ˆë‹¤ (ëŒ€í™”í˜• ëª¨ë“œì—ì„œë§Œ ì‘ë™)")
        return false
      end
    else
      UI.important("âš ï¸ API í‚¤ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: #{api_key_path}")
      UI.important("   í‚¤ì²´ì¸ ì¸ì¦ì„ ì‹œë„í•©ë‹ˆë‹¤. (ëŒ€í™”í˜• ëª¨ë“œì—ì„œë§Œ ì‘ë™)")
      return false
    end
  end

  desc "Flutter ë¹Œë“œ ë° TestFlightì— ì—…ë¡œë“œ"
  lane :beta do
    # CocoaPods ì„¤ì¹˜
    cocoapods(
      podfile: "./Podfile"
    )
    
    # ë¹Œë“œ ë²ˆí˜¸ ìë™ ì¦ê°€
    increment_build_number(
      xcodeproj: "Runner.xcodeproj"
    )
    
    # Flutter ë¹Œë“œ (IPA ìƒì„±) - í•­ìƒ ìƒˆë¡œ ë¹Œë“œ
    UI.important("ìƒˆë¡œìš´ IPA ë¹Œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...")
    sh("cd ../.. && flutter clean && flutter build ipa --release")
    
    # IPA íŒŒì¼ ê²½ë¡œ ì°¾ê¸°
    ipa_path = find_ipa_path
    
    # API í‚¤ ì„¤ì • ì‹œë„
    begin
      setup_api_key
    rescue => e
      UI.important("API í‚¤ ì„¤ì • ì‹¤íŒ¨: #{e.message}")
    end
    
    # TestFlightì— ì—…ë¡œë“œ
    api_key_set = setup_api_key
    
    begin
      upload_to_testflight(
        ipa: ipa_path,
        skip_waiting_for_build_processing: true,
        skip_submission: true
      )
      UI.success("âœ… TestFlightì— ì—…ë¡œë“œ ì™„ë£Œ!")
    rescue => e
      if !api_key_set
        UI.important("")
        UI.important("=" * 60)
        UI.important("âš ï¸ ìë™ ì—…ë¡œë“œ ì‹¤íŒ¨: API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤")
        UI.important("=" * 60)
        UI.important("ğŸ“¦ IPA íŒŒì¼ ìœ„ì¹˜:")
        UI.important("   #{ipa_path}")
        UI.important("")
        UI.important("ğŸ’¡ ì—…ë¡œë“œ ë°©ë²•:")
        UI.important("   1. Transporter ì•± ì‚¬ìš© (ê°€ì¥ ê°„ë‹¨)")
        UI.important("   2. API í‚¤ ì„¤ì • (ìë™í™” ê¶Œì¥)")
        UI.important("=" * 60)
        UI.success("âœ… ë¹Œë“œëŠ” ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
      else
        UI.user_error!("ì—…ë¡œë“œ ì‹¤íŒ¨: #{e.message}")
      end
    end
  end

  desc "Flutter ë¹Œë“œ ë° App Storeì— ì—…ë¡œë“œ (ì œì¶œ ì—†ìŒ)"
  lane :release do
    # CocoaPods ì„¤ì¹˜
    cocoapods(
      podfile: "./Podfile"
    )
    
    # ë¹Œë“œ ë²ˆí˜¸ ìë™ ì¦ê°€
    increment_build_number(
      xcodeproj: "Runner.xcodeproj"
    )
    
    # Flutter ë¹Œë“œ (IPA ìƒì„±) - í•­ìƒ ìƒˆë¡œ ë¹Œë“œ
    UI.important("ìƒˆë¡œìš´ IPA ë¹Œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...")
    sh("cd ../.. && flutter clean && flutter build ipa --release")
    
    # IPA íŒŒì¼ ê²½ë¡œ ì°¾ê¸°
    ipa_path = find_ipa_path
    
    # API í‚¤ ì„¤ì • ì‹œë„
    begin
      setup_api_key
    rescue => e
      UI.important("API í‚¤ ì„¤ì • ì‹¤íŒ¨: #{e.message}")
    end
    
    # App Storeì— ì—…ë¡œë“œ
    api_key_set = setup_api_key
    
    begin
      # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì„¤ì • (í•œêµ­ì–´ í•„ìˆ˜)
      release_notes = "MyGolfPlanner ì—…ë°ì´íŠ¸\n\nìƒˆë¡œìš´ ê¸°ëŠ¥ ë° ê°œì„ ì‚¬í•­:\n- ì„±ëŠ¥ ìµœì í™” ë° ì•ˆì •ì„± ê°œì„ \n- ë²„ê·¸ ìˆ˜ì • ë° ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ"
      
      upload_to_app_store(
        ipa: ipa_path,
        skip_metadata: false,  # ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ í™œì„±í™” (ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ í¬í•¨)
        skip_screenshots: true,
        submit_for_review: false,
        force: true,
        run_precheck_before_submit: false,  # In-app purchases ì²´í¬ ì œí•œìœ¼ë¡œ ì¸í•´ ë¹„í™œì„±í™”
        release_notes: {
          "ko-KR" => release_notes
        }
      )
      UI.success("âœ… App Storeì— ì—…ë¡œë“œ ì™„ë£Œ!")
      UI.important("ğŸ“ ì°¸ê³ : ë¹Œë“œê°€ ì²˜ë¦¬ë˜ë©´ App Store Connectì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì œì¶œí•´ì•¼ í•©ë‹ˆë‹¤.")
      UI.success("ğŸ“± App Store Connectì—ì„œ ë¹Œë“œ ì²˜ë¦¬ë¥¼ í™•ì¸í•˜ì„¸ìš”: https://appstoreconnect.apple.com")
    rescue => e
      # precheck ê²½ê³ ëŠ” ì‹¤ì œ ì˜¤ë¥˜ê°€ ì•„ë‹ˆë¯€ë¡œ ë¬´ì‹œ
      if e.message.include?("Precheck cannot check In-app purchases")
        UI.success("âœ… App Storeì— ì—…ë¡œë“œ ì™„ë£Œ!")
        UI.important("âš ï¸ Precheck ê²½ê³  (ë¬´ì‹œ ê°€ëŠ¥): In-app purchases ì²´í¬ ì œí•œ")
        UI.success("ğŸ“± App Store Connectì—ì„œ ë¹Œë“œ ì²˜ë¦¬ë¥¼ í™•ì¸í•˜ì„¸ìš”: https://appstoreconnect.apple.com")
        return
      end
      UI.important("")
      UI.important("=" * 60)
      if !api_key_set
        UI.important("âš ï¸ ìë™ ì—…ë¡œë“œ ì‹¤íŒ¨: API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
      else
        UI.important("âš ï¸ ìë™ ì—…ë¡œë“œ ì‹¤íŒ¨: API í‚¤ ì¸ì¦ ì˜¤ë¥˜")
        UI.important("   ì˜¤ë¥˜: #{e.message}")
        UI.important("")
        UI.important("   ê°€ëŠ¥í•œ ì›ì¸:")
        UI.important("   1. API í‚¤ì— 'App Manager' ê¶Œí•œì´ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤")
        UI.important("   2. API í‚¤ê°€ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì˜ëª»ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤")
        UI.important("   3. Issuer IDê°€ ì˜ëª»ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤")
      end
      UI.important("=" * 60)
      UI.important("ğŸ“¦ IPA íŒŒì¼ ìœ„ì¹˜:")
      UI.important("   #{ipa_path}")
      UI.important("")
      UI.important("ğŸ’¡ ì—…ë¡œë“œ ë°©ë²•:")
      UI.important("   1. Transporter ì•± ì‚¬ìš© (ê°€ì¥ ê°„ë‹¨, ê¶Œì¥):")
      UI.important("      - Mac App Storeì—ì„œ 'Transporter' ì„¤ì¹˜")
      UI.important("      - ìœ„ IPA íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­")
      UI.important("      - Apple IDë¡œ ë¡œê·¸ì¸í•˜ì—¬ ì—…ë¡œë“œ")
      UI.important("")
      UI.important("   2. API í‚¤ ê¶Œí•œ í™•ì¸:")
      UI.important("      - App Store Connect â†’ ì‚¬ìš©ì ë° ì•¡ì„¸ìŠ¤ â†’ í‚¤")
      UI.important("      - API í‚¤ì— 'App Manager' ë˜ëŠ” 'Admin' ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸")
      UI.important("      - í•„ìš”ì‹œ ìƒˆ í‚¤ ìƒì„± (ê¸°ì¡´ í‚¤ëŠ” ì‚­ì œ ë¶ˆê°€)")
      UI.important("=" * 60)
      UI.success("âœ… ë¹Œë“œëŠ” ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
    end
  end

  desc "Flutter ë¹Œë“œë§Œ (ì—…ë¡œë“œ ì—†ì´)"
  lane :build_only do
    # CocoaPods ì„¤ì¹˜
    cocoapods(
      podfile: "./Podfile"
    )
    
    sh("cd ../.. && flutter build ipa --release")
    ipa_path = find_ipa_path
    UI.success("ë¹Œë“œ ì™„ë£Œ: #{ipa_path}")
  end

  desc "TestFlightì— ì œì¶œ (ì´ë¯¸ ë¹Œë“œëœ IPA ì‚¬ìš©)"
  lane :upload_testflight do
    ipa_path = find_ipa_path
    
    # API í‚¤ ì„¤ì • ì‹œë„
    begin
      setup_api_key
    rescue => e
      UI.important("API í‚¤ ì„¤ì • ì‹¤íŒ¨: #{e.message}")
    end
    
    begin
      upload_to_testflight(
        ipa: ipa_path,
        skip_waiting_for_build_processing: true,
        skip_submission: true
      )
      UI.success("âœ… TestFlightì— ì—…ë¡œë“œ ì™„ë£Œ!")
    rescue => e
      UI.important("âš ï¸ ìë™ ì—…ë¡œë“œ ì‹¤íŒ¨: #{e.message}")
      UI.important("ğŸ“¦ IPA íŒŒì¼ ìœ„ì¹˜: #{ipa_path}")
      UI.user_error!("ì—…ë¡œë“œ ì‹¤íŒ¨")
    end
  end

  desc "App Storeì— ì œì¶œ (ì´ë¯¸ ë¹Œë“œëœ IPA ì‚¬ìš©)"
  lane :upload_appstore do
    ipa_path = find_ipa_path
    
    # API í‚¤ ì„¤ì • ì‹œë„
    begin
      setup_api_key
    rescue => e
      UI.important("API í‚¤ ì„¤ì • ì‹¤íŒ¨: #{e.message}")
    end
    
    begin
      upload_to_app_store(
        ipa: ipa_path,
        skip_metadata: true,
        skip_screenshots: true,
        submit_for_review: false,
        force: true
      )
      UI.success("âœ… App Storeì— ì—…ë¡œë“œ ì™„ë£Œ!")
    rescue => e
      UI.important("âš ï¸ ìë™ ì—…ë¡œë“œ ì‹¤íŒ¨: #{e.message}")
      UI.important("ğŸ“¦ IPA íŒŒì¼ ìœ„ì¹˜: #{ipa_path}")
      UI.user_error!("ì—…ë¡œë“œ ì‹¤íŒ¨")
    end
  end

  desc "Flutter ë¹Œë“œ ë° App Storeì— ìë™ ì œì¶œ (ë¦¬ë·° ì œì¶œ í¬í•¨)"
  lane :submit do
    # CocoaPods ì„¤ì¹˜
    cocoapods(
      podfile: "./Podfile"
    )
    
    # ë¹Œë“œ ë²ˆí˜¸ ìë™ ì¦ê°€
    increment_build_number(
      xcodeproj: "Runner.xcodeproj"
    )
    
    # Flutter ë¹Œë“œ (IPA ìƒì„±) - í•­ìƒ ìƒˆë¡œ ë¹Œë“œ
    UI.important("ìƒˆë¡œìš´ IPA ë¹Œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...")
    sh("cd ../.. && flutter clean && flutter build ipa --release")
    
    # IPA íŒŒì¼ ê²½ë¡œ ì°¾ê¸°
    ipa_path = find_ipa_path
    
    # API í‚¤ ì„¤ì • ì‹œë„
    begin
      setup_api_key
    rescue => e
      UI.important("API í‚¤ ì„¤ì • ì‹¤íŒ¨: #{e.message}")
    end
    
    # App Storeì— ì—…ë¡œë“œ ë° ì œì¶œ
    api_key_set = setup_api_key
    
    begin
      # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì„¤ì • (í•œêµ­ì–´ í•„ìˆ˜)
      release_notes = "MyGolfPlanner ì—…ë°ì´íŠ¸\n\nìƒˆë¡œìš´ ê¸°ëŠ¥ ë° ê°œì„ ì‚¬í•­:\n- ì„±ëŠ¥ ìµœì í™” ë° ì•ˆì •ì„± ê°œì„ \n- ë²„ê·¸ ìˆ˜ì • ë° ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ"
      
      upload_to_app_store(
        ipa: ipa_path,
        skip_metadata: false,  # ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ í™œì„±í™” (ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ í¬í•¨)
        skip_screenshots: true,
        submit_for_review: true,  # ìë™ ì œì¶œ í™œì„±í™”
        force: true,
        run_precheck_before_submit: false,  # In-app purchases ì²´í¬ ì œí•œìœ¼ë¡œ ì¸í•´ ë¹„í™œì„±í™”
        release_notes: {
          "ko-KR" => release_notes
        }
      )
      UI.success("âœ… App Storeì— ì—…ë¡œë“œ ë° ì œì¶œ ì™„ë£Œ!")
      UI.success("ğŸ“± ë¦¬ë·° ìƒíƒœë¥¼ App Store Connectì—ì„œ í™•ì¸í•˜ì„¸ìš”: https://appstoreconnect.apple.com")
    rescue => e
      # precheck ê²½ê³ ëŠ” ì‹¤ì œ ì˜¤ë¥˜ê°€ ì•„ë‹ˆë¯€ë¡œ ë¬´ì‹œ
      if e.message.include?("Precheck cannot check In-app purchases")
        UI.success("âœ… App Storeì— ì—…ë¡œë“œ ë° ì œì¶œ ì™„ë£Œ!")
        UI.important("âš ï¸ Precheck ê²½ê³  (ë¬´ì‹œ ê°€ëŠ¥): In-app purchases ì²´í¬ ì œí•œ")
        UI.success("ğŸ“± ë¦¬ë·° ìƒíƒœë¥¼ App Store Connectì—ì„œ í™•ì¸í•˜ì„¸ìš”: https://appstoreconnect.apple.com")
        return
      end
      UI.important("")
      UI.important("=" * 60)
      if !api_key_set
        UI.important("âš ï¸ ìë™ ì—…ë¡œë“œ ì‹¤íŒ¨: API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
      else
        UI.important("âš ï¸ ìë™ ì—…ë¡œë“œ ì‹¤íŒ¨: API í‚¤ ì¸ì¦ ì˜¤ë¥˜")
        UI.important("   ì˜¤ë¥˜: #{e.message}")
      end
      UI.important("=" * 60)
      UI.important("ğŸ“¦ IPA íŒŒì¼ ìœ„ì¹˜:")
      UI.important("   #{ipa_path}")
      UI.success("âœ… ë¹Œë“œëŠ” ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
    end
  end
end


