default_platform(:android)

platform :android do
  # ë©”íƒ€ë°ì´í„° ê²½ë¡œ ì„¤ì •
  METADATA_PATH = File.expand_path("metadata", __dir__)
  
  # Google Play Console API í‚¤ ì„¤ì •
  def setup_google_play_api_key
    json_key_path = File.expand_path("api-key.json", __dir__)
    
    if File.exist?(json_key_path)
      UI.success("âœ… Google Play Console API í‚¤ ì‚¬ìš©: #{json_key_path}")
      return json_key_path
    else
      UI.important("âš ï¸ Google Play Console API í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: #{json_key_path}")
      UI.important("   Google Play Console â†’ ì„¤ì • â†’ API ì•¡ì„¸ìŠ¤ â†’ ì„œë¹„ìŠ¤ ê³„ì • ìƒì„±")
      UI.important("   JSON í‚¤ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ìœ„ ê²½ë¡œì— ì €ì¥í•˜ì„¸ìš”")
      return nil
    end
  end
  
  desc "AAB íŒŒì¼ ê²½ë¡œ ì°¾ê¸°"
  def find_aab_path
    aab_path = File.expand_path("../../build/app/outputs/bundle/release/app-release.aab", __dir__)
    
    if File.exist?(aab_path)
      return aab_path
    end
    
    # ë‹¤ë¥¸ ê°€ëŠ¥í•œ ê²½ë¡œë“¤ í™•ì¸
    possible_paths = [
      File.expand_path("../../build/app/outputs/bundle/release/*.aab", __dir__),
      File.expand_path("../../build/app/outputs/bundle/*.aab", __dir__)
    ]
    
    possible_paths.each do |pattern|
      matches = Dir.glob(pattern)
      return matches.first if matches.any?
    end
    
    UI.user_error!("AAB íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¹Œë“œí•˜ì„¸ìš”: flutter build appbundle --release")
  end

  desc "Flutter ë¹Œë“œë§Œ (ì—…ë¡œë“œ ì—†ì´)"
  lane :build_only do
    sh("cd ../.. && flutter build appbundle --release")
    aab_path = find_aab_path
    UI.success("ë¹Œë“œ ì™„ë£Œ: #{aab_path}")
  end

  desc "Flutter ë¹Œë“œ ë° Google Playì— ì—…ë¡œë“œ (ì œì¶œ ì—†ìŒ)"
  lane :release do
    # Flutter ë¹Œë“œ (AAB ìƒì„±) - í•­ìƒ ìƒˆë¡œ ë¹Œë“œ
    UI.important("ìƒˆë¡œìš´ AAB ë¹Œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...")
    sh("cd ../.. && flutter clean && flutter build appbundle --release")
    
    # AAB íŒŒì¼ ê²½ë¡œ ì°¾ê¸°
    aab_path = find_aab_path
    
    # Google Play Console API í‚¤ ì„¤ì •
    json_key_path = setup_google_play_api_key
    
    if !json_key_path
      UI.important("")
      UI.important("=" * 60)
      UI.important("âš ï¸ ìë™ ì—…ë¡œë“œ ì‹¤íŒ¨: Google Play Console API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤")
      UI.important("=" * 60)
      UI.important("ğŸ“¦ AAB íŒŒì¼ ìœ„ì¹˜:")
      UI.important("   #{aab_path}")
      UI.important("")
      UI.important("ğŸ’¡ ì—…ë¡œë“œ ë°©ë²•:")
      UI.important("   1. Google Play Console ì›¹ì‚¬ì´íŠ¸ì—ì„œ ìˆ˜ë™ ì—…ë¡œë“œ (ê°€ì¥ ê°„ë‹¨)")
      UI.important("      - https://play.google.com/console ì ‘ì†")
      UI.important("      - ë‚´ ì•± â†’ MyGolfPlanner â†’ í”„ë¡œë•ì…˜ â†’ ìƒˆ ë²„ì „ ë§Œë“¤ê¸°")
      UI.important("      - ìœ„ AAB íŒŒì¼ ì—…ë¡œë“œ")
      UI.important("")
      UI.important("   2. Google Play Console API í‚¤ ì„¤ì • (ìë™í™” ê¶Œì¥):")
      UI.important("      - Google Play Console â†’ ì„¤ì • â†’ API ì•¡ì„¸ìŠ¤")
      UI.important("      - ìƒˆ ì„œë¹„ìŠ¤ ê³„ì • ìƒì„±")
      UI.important("      - JSON í‚¤ íŒŒì¼ ë‹¤ìš´ë¡œë“œ")
      UI.important("      - android/fastlane/api-key.jsonì— ì €ì¥")
      UI.important("=" * 60)
      UI.success("âœ… ë¹Œë“œëŠ” ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
      next
    end
    
    begin
      upload_to_play_store(
        aab: aab_path,
        track: "internal",  # internal, alpha, beta, production
        json_key: json_key_path,  # API í‚¤ íŒŒì¼ ê²½ë¡œ
        skip_upload_metadata: true,  # ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ ê±´ë„ˆë›°ê¸°
        skip_upload_images: true,
        skip_upload_screenshots: true,
        skip_upload_changelogs: true  # changelogë„ ê±´ë„ˆë›°ê¸°
      )
      UI.success("âœ… Google Playì— ì—…ë¡œë“œ ì™„ë£Œ!")
      UI.important("ğŸ“ ì°¸ê³ : Google Play Consoleì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì œì¶œí•´ì•¼ í•©ë‹ˆë‹¤.")
      UI.success("ğŸ“± Google Play Consoleì—ì„œ í™•ì¸í•˜ì„¸ìš”: https://play.google.com/console")
    rescue => e
      UI.important("")
      UI.important("=" * 60)
      UI.important("âš ï¸ ìë™ ì—…ë¡œë“œ ì‹¤íŒ¨: #{e.message}")
      UI.important("=" * 60)
      UI.important("ğŸ“¦ AAB íŒŒì¼ ìœ„ì¹˜:")
      UI.important("   #{aab_path}")
      UI.important("")
      UI.important("ğŸ’¡ ì—…ë¡œë“œ ë°©ë²•:")
      UI.important("   1. Google Play Console ì›¹ì‚¬ì´íŠ¸ì—ì„œ ìˆ˜ë™ ì—…ë¡œë“œ")
      UI.important("   2. Google Play Console API í‚¤ ì„¤ì • (ìë™í™” ê¶Œì¥)")
      UI.important("=" * 60)
      UI.success("âœ… ë¹Œë“œëŠ” ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
    end
  end

  desc "Flutter ë¹Œë“œ ë° Google Playì— ìë™ ì œì¶œ (ë¦¬ë·° ì œì¶œ í¬í•¨)"
  lane :submit do
    # Flutter ë¹Œë“œ (AAB ìƒì„±) - í•­ìƒ ìƒˆë¡œ ë¹Œë“œ
    UI.important("ìƒˆë¡œìš´ AAB ë¹Œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...")
    sh("cd ../.. && flutter clean && flutter build appbundle --release")
    
    # AAB íŒŒì¼ ê²½ë¡œ ì°¾ê¸°
    aab_path = find_aab_path
    
    # Google Play Console API í‚¤ ì„¤ì •
    json_key_path = setup_google_play_api_key
    
    if !json_key_path
      UI.important("")
      UI.important("=" * 60)
      UI.important("âš ï¸ ìë™ ì—…ë¡œë“œ ì‹¤íŒ¨: Google Play Console API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤")
      UI.important("=" * 60)
      UI.important("ğŸ“¦ AAB íŒŒì¼ ìœ„ì¹˜:")
      UI.important("   #{aab_path}")
      UI.important("")
      UI.important("ğŸ’¡ ì—…ë¡œë“œ ë°©ë²•:")
      UI.important("   1. Google Play Console ì›¹ì‚¬ì´íŠ¸ì—ì„œ ìˆ˜ë™ ì—…ë¡œë“œ (ê°€ì¥ ê°„ë‹¨)")
      UI.important("      - https://play.google.com/console ì ‘ì†")
      UI.important("      - ë‚´ ì•± â†’ MyGolfPlanner â†’ í”„ë¡œë•ì…˜ â†’ ìƒˆ ë²„ì „ ë§Œë“¤ê¸°")
      UI.important("      - ìœ„ AAB íŒŒì¼ ì—…ë¡œë“œ")
      UI.important("")
      UI.important("   2. Google Play Console API í‚¤ ì„¤ì • (ìë™í™” ê¶Œì¥):")
      UI.important("      - Google Play Console â†’ ì„¤ì • â†’ API ì•¡ì„¸ìŠ¤")
      UI.important("      - ìƒˆ ì„œë¹„ìŠ¤ ê³„ì • ìƒì„±")
      UI.important("      - JSON í‚¤ íŒŒì¼ ë‹¤ìš´ë¡œë“œ")
      UI.important("      - android/fastlane/api-key.jsonì— ì €ì¥")
      UI.important("=" * 60)
      UI.success("âœ… ë¹Œë“œëŠ” ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
      next
    end
    
    begin
      upload_to_play_store(
        aab: aab_path,
        track: "production",  # production íŠ¸ë™ì— ì œì¶œ
        json_key: json_key_path,  # API í‚¤ íŒŒì¼ ê²½ë¡œ
        skip_upload_metadata: true,  # ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ ê±´ë„ˆë›°ê¸° (Invalid request ë°©ì§€)
        skip_upload_images: true,
        skip_upload_screenshots: true,
        skip_upload_changelogs: true,  # changelogë„ ê±´ë„ˆë›°ê¸°
        changes_not_sent_for_review: false  # ë°”ë¡œ ë¦¬ë·°ì— ì œì¶œ
      )
      UI.success("âœ… Google Playì— ì—…ë¡œë“œ ë° ì œì¶œ ì™„ë£Œ!")
      UI.success("ğŸ“± ë¦¬ë·° ìƒíƒœë¥¼ Google Play Consoleì—ì„œ í™•ì¸í•˜ì„¸ìš”: https://play.google.com/console")
    rescue => e
      UI.important("")
      UI.important("=" * 60)
      UI.important("âš ï¸ ìë™ ì—…ë¡œë“œ ì‹¤íŒ¨: #{e.message}")
      UI.important("=" * 60)
      UI.important("ğŸ“¦ AAB íŒŒì¼ ìœ„ì¹˜:")
      UI.important("   #{aab_path}")
      UI.important("")
      UI.important("ğŸ’¡ ì—…ë¡œë“œ ë°©ë²•:")
      UI.important("   1. Google Play Console ì›¹ì‚¬ì´íŠ¸ì—ì„œ ìˆ˜ë™ ì—…ë¡œë“œ")
      UI.important("   2. Google Play Console API í‚¤ ì„¤ì • (ìë™í™” ê¶Œì¥)")
      UI.important("=" * 60)
      UI.success("âœ… ë¹Œë“œëŠ” ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
    end
  end

  desc "ë‚´ë¶€ í…ŒìŠ¤íŠ¸ íŠ¸ë™ì— ë°°í¬"
  lane :internal do
    # Flutter ë¹Œë“œ (AAB ìƒì„±) - í•­ìƒ ìƒˆë¡œ ë¹Œë“œ
    UI.important("ìƒˆë¡œìš´ AAB ë¹Œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...")
    sh("cd ../.. && flutter clean && flutter build appbundle --release")
    
    # AAB íŒŒì¼ ê²½ë¡œ ì°¾ê¸°
    aab_path = find_aab_path
    
    # Google Play Console API í‚¤ ì„¤ì •
    json_key_path = setup_google_play_api_key
    
    if !json_key_path
      UI.important("âš ï¸ ìë™ ì—…ë¡œë“œ ì‹¤íŒ¨: Google Play Console API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤")
      UI.important("ğŸ“¦ AAB íŒŒì¼ ìœ„ì¹˜: #{aab_path}")
      UI.important("ğŸ’¡ Google Play Console ì›¹ì‚¬ì´íŠ¸ì—ì„œ ìˆ˜ë™ ì—…ë¡œë“œí•˜ê±°ë‚˜ API í‚¤ë¥¼ ì„¤ì •í•˜ì„¸ìš”")
      UI.success("âœ… ë¹Œë“œëŠ” ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
      return
    end
    
    begin
      upload_to_play_store(
        aab: aab_path,
        track: "internal",  # ë‚´ë¶€ í…ŒìŠ¤íŠ¸ íŠ¸ë™
        json_key: json_key_path,  # API í‚¤ íŒŒì¼ ê²½ë¡œ
        skip_upload_metadata: true,  # ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ ê±´ë„ˆë›°ê¸°
        skip_upload_images: true,
        skip_upload_screenshots: true,
        skip_upload_changelogs: true  # changelogë„ ê±´ë„ˆë›°ê¸°
      )
      UI.success("âœ… ë‚´ë¶€ í…ŒìŠ¤íŠ¸ íŠ¸ë™ì— ì—…ë¡œë“œ ì™„ë£Œ!")
      UI.success("ğŸ“± Google Play Consoleì—ì„œ í™•ì¸í•˜ì„¸ìš”: https://play.google.com/console")
    rescue => e
      UI.important("âš ï¸ ìë™ ì—…ë¡œë“œ ì‹¤íŒ¨: #{e.message}")
      UI.important("ğŸ“¦ AAB íŒŒì¼ ìœ„ì¹˜: #{aab_path}")
      UI.success("âœ… ë¹Œë“œëŠ” ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
    end
  end
end
